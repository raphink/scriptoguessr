<!DOCTYPE html>
<html>
<head>
    <title>Bible Guessr</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: #f5f5f5;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .game-container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
        }

        .verse-panel {
            flex: 1;
            padding: 40px;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .verse-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .target-verse {
            font-family: 'Crimson Text', Georgia, serif;
            font-size: 24px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #000;
        }

        .context-verses {
            font-family: 'Crimson Text', Georgia, serif;
            font-size: 18px;
            line-height: 1.6;
            color: #999;
            filter: blur(3px);
        }

        .navigation-panel {
            width: 200px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: width 0.3s ease;
            position: relative;
        }

        .navigation-panel.opened {
            width: 400px;
        }

        #bible-svg {
            height: 100%;
            width: auto;
        }

        .score {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #007bff;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        .reference-display {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px;
            font-size: 18px;
            font-weight: 500;
            border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 100;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
</head>
<body>
    <div class="game-container">
        <div class="verse-panel">
            <div class="verse-content">
                <div class="target-verse" id="target-verse">
                    Loading verse...
                </div>
                <div class="context-verses" id="context-verses">
                </div>
            </div>
        </div>

        <div class="navigation-panel" id="navigation-panel">
            <div id="nav-container">
            </div>
            <div class="reference-display" id="reference-display">
            </div>
        </div>
    </div>

    <div class="score">Score: <span id="score">0</span></div>

    <div class="controls">
        <button id="submit-guess" style="display: none;">Make Guess</button>
        <button id="next-verse" style="display: none;">Next Verse</button>
    </div>

    <script>
        const BOOKS = [
            'Genesis', 'Exodus', 'Leviticus', 'Numbers', 'Deuteronomy',
            'Joshua', 'Judges', 'Ruth', '1 Samuel', '2 Samuel',
            '1 Kings', '2 Kings', '1 Chronicles', '2 Chronicles',
            'Ezra', 'Nehemiah', 'Esther', 'Job', 'Psalms',
            'Proverbs', 'Ecclesiastes', 'Song of Solomon', 'Isaiah',
            'Jeremiah', 'Lamentations', 'Ezekiel', 'Daniel', 'Hosea',
            'Joel', 'Amos', 'Obadiah', 'Jonah', 'Micah', 'Nahum',
            'Habakkuk', 'Zephaniah', 'Haggai', 'Zechariah', 'Malachi',
            'Matthew', 'Mark', 'Luke', 'John', 'Acts',
            'Romans', '1 Corinthians', '2 Corinthians', 'Galatians',
            'Ephesians', 'Philippians', 'Colossians', '1 Thessalonians',
            '2 Thessalonians', '1 Timothy', '2 Timothy', 'Titus',
            'Philemon', 'Hebrews', 'James', '1 Peter', '2 Peter',
            '1 John', '2 John', '3 John', 'Jude', 'Revelation'
        ];

        let BIBLE_MAP = null;

        async function buildBibleMap() {
            const map = {};
            console.log('Building Bible map...');
            
            for (const book of BOOKS) {
                map[book] = { chapters: {} };
                let chapter = 1;
                let hasMore = true;

                while (hasMore) {
                    try {
                        const response = await fetch(`https://bible-api.com/${book}+${chapter}:1`);
                        const data = await response.json();
                        
                        if (data.error) {
                            hasMore = false;
                        } else {
                            // Found a valid chapter, now find last verse
                            let verse = 1;
                            let lastValidVerse = 1;
                            let searching = true;

                            while (searching) {
                                const verseResponse = await fetch(`https://bible-api.com/${book}+${chapter}:${verse}`);
                                const verseData = await verseResponse.json();
                                
                                if (verseData.error) {
                                    searching = false;
                                } else {
                                    lastValidVerse = verse;
                                    verse += 5; // Skip by 5s for efficiency
                                }
                            }

                            // Binary search for exact last verse
                            let left = Math.max(1, lastValidVerse - 4);
                            let right = lastValidVerse;
                            while (left <= right) {
                                verse = Math.floor((left + right) / 2);
                                const verseResponse = await fetch(`https://bible-api.com/${book}+${chapter}:${verse}`);
                                const verseData = await verseResponse.json();
                                
                                if (verseData.error) {
                                    right = verse - 1;
                                } else {
                                    left = verse + 1;
                                    lastValidVerse = verse;
                                }
                            }

                            map[book].chapters[chapter] = lastValidVerse;
                            chapter++;
                        }
                    } catch (error) {
                        console.error(`Error processing ${book} ${chapter}:`, error);
                        hasMore = false;
                    }
                }
            }
            
            console.log('Bible map complete:', map);
            return map;
        }

        function generateContextVerses(mainVerse) {
            return [
                "Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
                mainVerse,
                "Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua."
            ].join('\n\n');
        }

        function openBible() {
            document.getElementById('navigation-panel').classList.add('opened');
            document.getElementById('reference-display').style.display = 'block';
        }

        function closeBible() {
            document.getElementById('navigation-panel').classList.remove('opened');
            document.getElementById('reference-display').style.display = 'none';
        }

        function loadSVG() {
            console.log('Attempting to load SVG...');
            $.ajax({
                url: 'book.svg',
                dataType: 'text',
                success: function(svgText) {
                    console.log('SVG loaded successfully');
                    document.getElementById('nav-container').innerHTML = svgText;
                    const svg = document.querySelector('svg');
                    svg.id = 'bible-svg';
                    console.log('SVG added to DOM with id:', svg.id);
                    initializeEventListeners();
                },
                error: function(error) {
                    console.error('Error loading SVG:', error);
                    document.getElementById('nav-container').innerHTML = 'Error loading Bible navigation';
                }
            });
        }

        function initializeEventListeners() {
            console.log('Initializing event listeners...');
            const svg = document.querySelector('#bible-svg');
            if (!svg) {
                console.error('SVG element not found');
                return;
            }
            console.log('SVG element found, adding click listener');

            svg.addEventListener('click', (e) => {
                console.log('SVG clicked');
                const rect = svg.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percentage = (x / rect.width) * 100;
                
                console.log('Click position:', { x, percentage });
                
                selectedPosition = calculateBiblePosition(percentage);
                console.log('Selected position:', selectedPosition);
                
                const marker = svg.querySelector('#position-marker');
                if (marker) {
                    const svgX = (percentage / 100) * 260 + 20;
                    marker.setAttribute('x1', svgX);
                    marker.setAttribute('x2', svgX);
                    console.log('Marker updated to position:', svgX);
                } else {
                    console.error('Marker element not found');
                }

                document.getElementById('reference-display').textContent = 
                    `${selectedPosition.book} ${selectedPosition.chapter}:${selectedPosition.verse}`;
                
                openBible();
                document.getElementById('submit-guess').style.display = 'block';
            });
            console.log('Event listeners initialized');
        }

        function calculateBiblePosition(percentage) {
            const bookIndex = Math.floor((percentage / 100) * BOOKS.length);
            const chapter = Math.floor((Math.random() * 20) + 1);
            const verse = Math.floor((Math.random() * 30) + 1);
            
            return {
                book: BOOKS[bookIndex] || BOOKS[0],
                chapter: Math.min(chapter, 150),
                verse: Math.min(verse, 176)
            };
        }

        async function fetchRandomVerse() {
            console.log('Fetching random verse...');
            try {
                const randomBook = BOOKS[Math.floor(Math.random() * BOOKS.length)];
                const randomChapter = Math.floor(Math.random() * 20) + 1;
                const randomVerse = Math.floor(Math.random() * 30) + 1;
                
                console.log(`Attempting to fetch ${randomBook} ${randomChapter}:${randomVerse}`);
                
                const response = await fetch(
                    `https://bible-api.com/${randomBook}+${randomChapter}:${randomVerse}`
                );
                const data = await response.json();
                
                if (data.error) {
                    console.log('Verse not found, retrying...');
                    return fetchRandomVerse();
                }

                console.log('Verse fetched successfully:', data);

                currentVerse = {
                    text: data.text.trim(),
                    book: randomBook,
                    chapter: randomChapter,
                    verse: randomVerse
                };

                document.getElementById('target-verse').textContent = currentVerse.text;
                document.getElementById('context-verses').innerHTML = generateContextVerses(currentVerse.text);
                
                closeBible();
                document.getElementById('submit-guess').style.display = 'none';
                document.getElementById('next-verse').style.display = 'none';
            } catch (error) {
                console.error('Error fetching verse:', error);
                document.getElementById('target-verse').textContent = 'Error loading verse';
            }
        }

        async function fetchNextVerse() {
            const currentBookIndex = BOOKS.indexOf(currentVerse.book);
            let nextBook = currentVerse.book;
            let nextChapter = currentVerse.chapter;
            let nextVerse = currentVerse.verse + 1;

            try {
                const response = await fetch(
                    `https://bible-api.com/${nextBook}+${nextChapter}:${nextVerse}`
                );
                const data = await response.json();
                
                if (data.error) {
                    nextVerse = 1;
                    nextChapter++;
                    const chapterResponse = await fetch(
                        `https://bible-api.com/${nextBook}+${nextChapter}:${nextVerse}`
                    );
                    const chapterData = await chapterResponse.json();
                    
                    if (chapterData.error) {
                        nextChapter = 1;
                        nextVerse = 1;
                        const bookIndex = (currentBookIndex + 1) % BOOKS.length;
                        nextBook = BOOKS[bookIndex];
                    } else {
                        data = chapterData;
                    }
                }

                currentVerse = {
                    text: data.text.trim(),
                    book: nextBook,
                    chapter: nextChapter,
                    verse: nextVerse
                };

                document.getElementById('target-verse').textContent = currentVerse.text;
                document.getElementById('context-verses').innerHTML = generateContextVerses(currentVerse.text);
                
                closeBible();
                document.getElementById('submit-guess').style.display = 'none';
                document.getElementById('next-verse').style.display = 'none';
            } catch (error) {
                console.error('Error fetching next verse:', error);
            }
        }

        document.getElementById('submit-guess').addEventListener('click', () => {
            if (!selectedPosition) {
                alert('Please select a position first');
                return;
            }

            const points = calculateScore(selectedPosition, currentVerse);
            score = points; // Just show current round score
            document.querySelector('.score').textContent = `Score: ${points}/5000`;
            
            document.getElementById('submit-guess').style.display = 'none';
            document.getElementById('next-verse').style.display = 'inline-block';
        });

        document.getElementById('next-verse').addEventListener('click', () => {
            document.getElementById('submit-guess').style.display = 'none';
            document.getElementById('next-verse').style.display = 'none';
            closeBible();
            fetchNextVerse();
        });

        function calculateScore(guess, actual) {
            if (!guess || !actual) return 0;

            const guessBookIndex = BOOKS.indexOf(guess.book);
            const actualBookIndex = BOOKS.indexOf(actual.book);
            
            const bookDistance = Math.abs(guessBookIndex - actualBookIndex);
            const chapterDistance = Math.abs(guess.chapter - actual.chapter);
            const verseDistance = Math.abs(guess.verse - actual.verse);
            
            const totalDistance = (bookDistance / BOOKS.length) + (chapterDistance / 150) + (verseDistance / 176);
            return Math.round(5000 * Math.exp(-5 * totalDistance));
        }

        $(document).ready(function() {
            console.log('Document ready, starting initialization...');
            loadSVG();
            fetchRandomVerse();
        });
    </script>
</body>
</html>